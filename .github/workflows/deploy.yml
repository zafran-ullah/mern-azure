name: Build and Deploy MERN to Azure

on:
  push:
    branches:
      - main

env:
  REGISTRY: mernacr123.azurecr.io
  CLIENT_IMAGE: mern-client
  SERVER_IMAGE: mern-server
  RESOURCE_GROUP: mern-group
  WEBAPP_NAME: mern-app-zafran

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      run: echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.ACR_USERNAME }} --password-stdin

    - name: Build and push client image
      run: |
        docker build -t $REGISTRY/$CLIENT_IMAGE:latest ./client
        docker push $REGISTRY/$CLIENT_IMAGE:latest

    - name: Build and push server image
      run: |
        docker build -t $REGISTRY/$SERVER_IMAGE:latest ./server
        docker push $REGISTRY/$SERVER_IMAGE:latest

    - name: Deploy to Azure Web App using Docker Compose
      run: |
        # Upload the docker-compose file to Azure
        az webapp config container set \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP \
          --multicontainer-config-type compose \
          --multicontainer-config-file docker-compose.prod.yml
        
        # Set environment variables for the web app
        az webapp config appsettings set \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP \
          --settings WEBSITES_PORT=80 WEBSITES_ENABLE_APP_SERVICE_STORAGE=false
        
        # Enable container logging
        az webapp log config \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP \
          --docker-container-logging filesystem
        
        # Restart to apply changes
        az webapp restart --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP
        
        # Wait a moment for the app to start
        sleep 30
        
        # Show recent logs for debugging
        echo "Recent logs:"
        az webapp log download --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP --log-file deployment_logs.zip || true
